{"version":3,"sources":["../assets/scripts/data-viz.js"],"names":["$","extend","obj","src","key","hasOwnProperty","sendEmbedMessage","message","value","window","parent","postMessage","secret","getSecret","self","top","location","hash","replace","clearTimeout","secretTimeout","setTimeout","setHeight","Math","ceil","document","body","getBoundingClientRect","height","fn","initCharts","this","find","each","setTransients","viz","viz_lg","settings","action","security","Ajax","id","toJSON","post","ajaxurl","response","drawCharts","draw","google","visualization","events","addListener","json","type","chart_image","getChart","getImageURI","hide","promise","done","removeClass","data","png","html","resize","getViz","options","chartArea","left","width","legend","position","titlePosition","axisTitlesPosition","vAxis","textPosition","hAxis","tooltip","isHtml","colors","fontName","custom","eval","d","options_lg","JSON","parse","stringify","columns","ChartWrapper","chartType","dataSourceUrl","data_source","view","containerId","chart","chart_lg","attr","setView","jQuery"],"mappings":"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","file":"data-viz.js","sourcesContent":["/**\n * Everything we need to load data visualizations\n */\n(function ($) {\n\n  // Merges two arrays\n  function extend(obj, src) {\n    for (var key in src) {\n      if (src.hasOwnProperty(key)) {\n        obj[key] = src[key];\n      }\n    }\n    return obj;\n  }\n\n  /**\n   * For embeds: Send this document's height to the parent (embedding) site.\n   * The code for the next 3 functions were adapted from the default wp-embed-template.js file\n   */\n  var message, secret, secretTimeout;\n  function sendEmbedMessage( message, value ) {\n  \twindow.parent.postMessage( {\n  \t\tmessage: message,\n  \t\tvalue: value,\n  \t\tsecret: secret\n  \t}, '*' );\n  }\n  function getSecret() {\n    if ( window.self === window.top || !!secret ) {\n     return;\n    }\n\n    secret = window.location.hash.replace( /.*secret=([\\d\\w]{10}).*/, '$1' );\n\n    clearTimeout( secretTimeout );\n\n    secretTimeout = setTimeout( function () {\n     getSecret();\n    }, 100 );\n  }\n  function setHeight() {\n    if ( window.self === window.top ) {\n    \treturn;\n    }\n    getSecret();\n\n    sendEmbedMessage( 'height', Math.ceil( document.body.getBoundingClientRect().height ) );\n  }\n\n\n  /**\n   * This function handles loading the charts\n   */\n  $.fn.initCharts = function() {\n    \n    // Loop through each data-viz on page\n    this.find('.data-section.has-data-viz').each(function() {\n      var chart, chart_lg,\n          id = $(this).attr('id'),  // Unique ID for this data viz\n          json = window[id];  // Data for chart passed from PHP\n\n      /**\n       * Use AJAX to check WP Transients for cached charts data\n       */\n      var settings = {\n        action: 'check_dataviz_transients',\n        security: Ajax.security,\n        id: id\n      };\n\n      $.post(Ajax.ajaxurl, settings, function(response) {\n        response = JSON.parse(response);\n        if (response.viz) {\n          // Get data from transients and draw\n          viz = new google.visualization.ChartWrapper(response.viz.replace(/\\\\\"/g, '\"').replace(/\\\\'/g, '\\''));\n          viz_lg = new google.visualization.ChartWrapper(response.viz_lg.replace(/\\\\\"/g, '\"').replace(/\\\\'/g, '\\''));\n\n          // Make sure columns are properly included since toJSON() drops calculated columns for some unknown reason\n          var columns = eval(json.d.columns);\n          viz.setView({'columns' : columns});\n          viz_lg.setView({'columns' : columns});\n\n          drawCharts(viz, viz_lg);\n        } else {\n          // If no transient, use JS to get data and build chart\n          getViz();\n        }\n      });\n\n\n      /**\n       * Use AJAX to set chart data in WP Transients\n       */\n      function setTransients(viz, viz_lg) {\n        var settings = {\n          action: 'set_dataviz_transients',\n          security: Ajax.security,\n          id: id,\n          viz: viz.toJSON(),\n          viz_lg: viz_lg.toJSON()\n        };\n\n        $.post(Ajax.ajaxurl, settings, function(response) {});\n      }\n\n\n      /**\n       * Draw charts\n       */\n      function drawCharts(viz, viz_lg) {\n        // Draw main chart\n        viz.draw();\n\n        // Draw large chart that image is generated from\n        viz_lg.draw();\n\n        google.visualization.events.addListener(viz_lg, 'ready', function () {\n          // Get PNG image of large chart\n          if (json.type !== 'Table') {\n            var chart_image = viz_lg.getChart().getImageURI();\n            $('#viz_lg_' + id + ', #viz_png_' + id).hide().promise().done(setHeight());\n            $('#viz_png_' + id).removeClass('loading');\n\n            // Save PNG to server with AJAX\n            var data = {\n              action: 'save_png',\n              security: Ajax.security,\n              png: chart_image,\n              id: id\n            };\n\n            $.post(Ajax.ajaxurl, data, function(response) {\n              // Display image that was just saved to server\n              $('#viz_png_' + id).html('<img src=\"' + response + '\">');\n            });\n          } else {\n            $('#viz_lg_' + id).hide();\n          }\n\n          // For embeds: Fix iframe height after charts load\n          google.visualization.events.addListener(viz, 'ready', function(response) {\n            setHeight();\n          });\n\n          // Make sure charts and iframes they're embedded in are responsive\n          $(window).resize(function() {\n            // Redraw chart to correct width on resize\n            viz.draw();\n            // Fix height of iframe on resize\n            setHeight();\n          });\n        });\n      }\n\n\n      /**\n       * Get chart visualization\n       */\n      function getViz() {\n        // Default options\n        var options = {\n          height: 400,\n          chartArea: {left: 'auto', width: '85%', top: 10, height: '85%'},\n          legend: {position: 'in'},\n          titlePosition: 'in',\n          axisTitlesPosition: 'in',\n          vAxis: {textPosition: 'in'},\n          hAxis: {textPosition: 'out'},\n          tooltip: {isHtml: true},\n          colors: ['#731454', '#9D0E2B', '#C73F13', '#DE6515', '#EDBC2D', '#B8B839', '#98A942', '#62975E', '#5681B3', '#314C83', '#24346D', '#3E296A'],\n          fontName: 'Lato'\n        };\n\n        // Convert string passed through JSON into object\n        var custom = eval(\"[{\" + json.d.options + \"}]\");\n\n        // Merge option defaults with custom options\n        extend(options, custom[0]);\n\n        // Create new options var for large chart that image is generated from\n        var options_lg = JSON.parse(JSON.stringify(options));\n\n        extend(options_lg, {width: 1200, height: 630});\n\n        var columns = eval(json.d.columns);\n\n        var viz = new google.visualization.ChartWrapper({\n          chartType: json.type,\n          dataSourceUrl: json.d.data_source + '/gviz/tq?',\n          options: options,\n          view: {'columns' : columns},\n          containerId: 'viz_' + id\n        });\n\n        var viz_lg = new google.visualization.ChartWrapper({\n          chartType: json.type,\n          dataSourceUrl: json.d.data_source + '/gviz/tq?',\n          options: options_lg,\n          view: {'columns' : columns},\n          containerId: 'viz_lg_' + id\n        });\n\n        // Draw the charts\n        drawCharts(viz, viz_lg);\n\n        // Set the transients\n        setTransients(viz, viz_lg);\n      }\n\n    });\n\n    return this;\n  };\n\n})(jQuery);\n"],"sourceRoot":"assets/scripts/"}