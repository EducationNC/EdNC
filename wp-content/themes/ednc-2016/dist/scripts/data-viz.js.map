{"version":3,"sources":["../assets/scripts/data-viz.js"],"names":["extend","obj","src","key","hasOwnProperty","sendEmbedMessage","message","value","window","parent","postMessage","secret","getSecret","self","top","location","hash","replace","clearTimeout","secretTimeout","setTimeout","setHeight","Math","ceil","document","body","getBoundingClientRect","height","jQuery","ready","$","getData","each","handleQueryResponse","response","isError","alert","getMessage","getDetailedMessage","data","getDataTable","view","google","visualization","DataView","options","chartArea","left","width","legend","position","titlePosition","axisTitlesPosition","vAxis","textPosition","hAxis","tooltip","isHtml","colors","fontName","custom","eval","json","d","options_png","JSON","parse","stringify","extra_js","chart","chart_png","type","ColumnChart","id","PieChart","ScatterChart","Table","draw","events","addListener","chart_image","getImageURI","hide","promise","done","save_png_data","action","security","Ajax","png","post","ajaxurl","html","resize","this","attr","query","Query","data_source","query_string","send","charts","load","packages","setOnLoadCallback"],"mappings":"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","file":"data-viz.js","sourcesContent":["// Merges two arrays\nfunction extend(obj, src) {\n  for (var key in src) {\n    if (src.hasOwnProperty(key)) {\n      obj[key] = src[key];\n    }\n  }\n  return obj;\n}\n\n/**\n * For embeds: Send this document's height to the parent (embedding) site.\n * This code was taken from the wp-embed-template.js file\n */\nvar message, secret, secretTimeout;\n\nfunction sendEmbedMessage( message, value ) {\n\twindow.parent.postMessage( {\n\t\tmessage: message,\n\t\tvalue: value,\n\t\tsecret: secret\n\t}, '*' );\n}\n\nfunction getSecret() {\n  if ( window.self === window.top || !!secret ) {\n   return;\n  }\n\n  secret = window.location.hash.replace( /.*secret=([\\d\\w]{10}).*/, '$1' );\n\n  clearTimeout( secretTimeout );\n\n  secretTimeout = setTimeout( function () {\n   getSecret();\n  }, 100 );\n}\n\nfunction setHeight() {\n  if ( window.self === window.top ) {\n  \treturn;\n  }\n  getSecret();\n\n  sendEmbedMessage( 'height', Math.ceil( document.body.getBoundingClientRect().height ) );\n}\n\n/**\n * Using jQuery for most of the data viz functionality\n */\njQuery(document).ready(function($) {\n\n  // Load Google Charts API\n  google.charts.load('current', {packages: ['corechart', 'table']});\n  google.charts.setOnLoadCallback(getData);\n\n  function getData() {\n\n    $('.data-section.has-data-viz').each(function() {\n      // Unique ID for this data viz\n      var id = $(this).attr('id');\n\n      // Get JSON data passed from PHP\n      var json = window[id];\n\n      // Get data from Google Spreadsheet\n      var query = new google.visualization.Query(json.d.data_source + '/gviz/tq?' + json.d.query_string);\n      query.send(handleQueryResponse);\n\n      // This function takes the data from the query and draws charts\n      function handleQueryResponse(response) {\n        // Throw alert if there is an error\n        if (response.isError()) {\n          alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());\n          return;\n        }\n\n        // Set up data and options for Charts API\n        var data = response.getDataTable();\n        var view = new google.visualization.DataView(data);\n\n        // Defaults\n        var options = {\n          chartArea: {left: 'auto', width: '85%', top: 10, height: '85%'},\n          legend: {position: 'in'},\n          titlePosition: 'in',\n          axisTitlesPosition: 'in',\n          vAxis: {textPosition: 'in'},\n          hAxis: {textPosition: 'out'},\n          tooltip: {isHtml: true},\n          colors: ['#731454', '#9D0E2B', '#C73F13', '#DE6515', '#EDBC2D', '#B8B839', '#98A942', '#62975E', '#5681B3', '#314C83', '#24346D', '#3E296A'],\n          fontName: 'Lato'\n        };\n\n        // Convert string passed through JSON into object\n        var custom = eval(\"[{\" + json.d.options + \"}]\");\n\n        // Merge option defaults with custom options\n        extend(options, custom[0]);\n\n        // Create new options var for chart image\n        var options_png = JSON.parse(JSON.stringify(options));\n\n        // Make dimensions for chart image larger\n        extend(options_png, {width: 1200, height: 630});\n\n        // Pull in extra functions specific to this visualization\n        eval(json.d.extra_js);\n\n        // Get chart visualizations from Google\n        var chart, chart_png;\n        if (json.d.type === 'bar_chart') {\n          chart = new google.visualization.ColumnChart($('#dataviz_' + id)[0]);\n          chart_png = new google.visualization.ColumnChart($('#dataviz_lg_' + id)[0]);\n        } else if (json.d.type === 'pie_chart') {\n          chart = new google.visualization.PieChart($('#dataviz_' + id)[0]);\n          chart_png = new google.visualization.PieChart($('#dataviz_lg_' + id)[0]);\n        } else if (json.d.type === 'scatter_chart') {\n          chart = new google.visualization.ScatterChart($('#dataviz_' + id)[0]);\n          chart_png = new google.visualization.ScatterChart($('#dataviz_lg_' + id)[0]);\n        } else if (json.d.type === 'table') {\n          chart = new google.visualization.Table($('#dataviz_' + id)[0]);\n          chart_png = new google.visualization.Table($('#dataviz_lg_' + id)[0]);\n        }\n\n        // Draw main chart\n        chart.draw(view, options);\n\n        // Draw large PNG chart for printing and sharing\n        chart_png.draw(view, options_png);\n\n        // Get PNG image of chart\n        google.visualization.events.addListener(chart_png, 'ready', function () {\n          var chart_image = chart_png.getImageURI();\n          $('#dataviz_lg_' + id).hide().promise().done(setHeight());\n\n          // Save PNG to server with AJAX\n          var save_png_data = {\n            action: 'save_png',\n            security: Ajax.security,\n            png: chart_image,\n            id: id\n          };\n\n          $.post(Ajax.ajaxurl, save_png_data, function(response) {\n            // Display image that was just saved to server\n            $('#dataviz_png_' + id).html('<img src=\"' + response + '\">');\n          });\n        });\n\n        // For embeds: Fix iframe height\n        google.visualization.events.addListener(chart, 'ready', function(response) {\n          setHeight();\n        });\n\n        jQuery(window).resize(function() {\n          // Redraw chart to correct width on resize\n          chart.draw(view, options);\n          // Fix height of iframe on resize\n          // setHeight();\n        });\n      }\n\n    });\n  }\n});\n"],"sourceRoot":"assets/scripts/"}